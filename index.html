<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Hippodrome Paris-Vincennes</title>
  <style>
    body {
      background-color: #1e1e2f;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding: 2rem;
    }
    h1 {
      margin-bottom: 2rem;
    }
    .section {
      margin-bottom: 3rem;
    }
    .station-title {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }
    .passage {
      padding: 1rem;
      background-color: #292943;
      border-radius: 0.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .passage.highlight {
      background-color: #4caf50;
      color: #000;
      font-weight: bold;
    }
    .passage.late {
      background-color: #444;
      color: #aaa;
    }
    .passage.cancelled {
      background-color: #ff5252;
      color: white;
      text-decoration: line-through;
    }
    .alert {
      background-color: #ffc107;
      color: #000;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.5rem;
    }
    .ligne-title {
      margin: 1rem 0 0.5rem;
      font-weight: bold;
      font-size: 1.2rem;
      color: #00bcd4;
    }
    .ligne-title img {
      height: 20px;
      vertical-align: middle;
      margin-right: 5px;
    }
    #weather {
      font-size: 1rem;
      margin-bottom: 2rem;
      background: #333;
      padding: 1rem;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>üöâ Dashboard Hippodrome Paris-Vincennes</h1>
  <div id="weather">üå§Ô∏è Chargement de la m√©t√©o...</div>
  <div class="section" id="joinville"></div>
  <div class="section" id="hippodrome"></div>
  <div class="section" id="breuil"></div>

  <script>
    const monitoringRefs = {
      joinville: {
        name: "Joinville-le-Pont",
        refs: [
          "STIF:StopArea:SP:43135:",
          "STIF:StopArea:SP:463646:",
          "STIF:StopArea:SP:463643:",
          "STIF:StopArea:SP:C02251:", "STIF:StopArea:SP:C01130:", "STIF:StopArea:SP:C01135:",
          "STIF:StopArea:SP:C01137:", "STIF:StopArea:SP:C01139:", "STIF:StopArea:SP:C01141:",
          "STIF:StopArea:SP:C01219:", "STIF:StopArea:SP:C01260:", "STIF:StopArea:SP:C01399:"
        ]
      },
      hippodrome: {
        name: "Hippodrome de Vincennes",
        refs: ["STIF:StopArea:SP:463642:"]
      },
      breuil: {
        name: "√âcole du Breuil",
        refs: ["STIF:StopArea:SP:463645:"]
      }
    };

    async function fetchData(monitoringRef) {
      const proxy = 'https://ratp-proxy.hippodrome-proxy42.workers.dev/?url=';
      const url = `https://prim.iledefrance-mobilites.fr/marketplace/stop-monitoring?MonitoringRef=${monitoringRef}`;
      try {
        const response = await fetch(proxy + encodeURIComponent(url));
        const data = await response.json();
        return data.Siri.ServiceDelivery.StopMonitoringDelivery[0];
      } catch (e) {
        return null;
      }
    }

    function formatTime(dateStr) {
      const date = new Date(dateStr);
      return isNaN(date) ? 'Invalid Date' : date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    }

    function minutesRemaining(dateStr) {
      const now = new Date();
      const then = new Date(dateStr);
      return Math.round((then - now) / 60000);
    }

    function renderDepartures(containerId, title, deliveriesList) {
      const el = document.getElementById(containerId);
      el.innerHTML = `<div class="station-title">${title}</div>`;
      const lignes = {};

      deliveriesList.forEach(deliveries => {
        if (!deliveries || !deliveries.MonitoredStopVisit) return;

        deliveries.MonitoredStopVisit.forEach(v => {
          const dir = v.MonitoredVehicleJourney.DirectionName?.value || '';
          const line = v.MonitoredVehicleJourney.LineRef?.value || '';
          const destination = v.MonitoredVehicleJourney.DestinationName?.value || '';
          const scheduled = v.MonitoredVehicleJourney.MonitoredCall.AimedDepartureTime;
          const status = v.MonitoredVehicleJourney.MonitoredCall.DepartureStatus || '';
          const delay = v.MonitoredVehicleJourney.MonitoredCall.ArrivalProximityText || '';
          const minutes = minutesRemaining(scheduled);
          const heure = formatTime(scheduled);

          const key = `${line} ‚Üí ${destination}`;
          if (!lignes[key]) lignes[key] = [];
          lignes[key].push({heure, minutes, status});
        });

        if (deliveries?.GeneralMessage) {
          deliveries.GeneralMessage.forEach(m => {
            const alert = document.createElement('div');
            alert.className = 'alert';
            alert.textContent = '‚ö† ' + (m?.InfoMessage?.[0]?.value || 'Perturbation');
            el.appendChild(alert);
          });
        }
      });

      Object.entries(lignes).forEach(([dir, passages]) => {
        const block = document.createElement('div');
        block.innerHTML = `<div class="ligne-title">üöç ${dir}</div>`;
        const grid = document.createElement('div');
        grid.className = 'grid';
        passages.slice(0, 4).forEach(p => {
          const div = document.createElement('div');
          let classe = 'passage';
          if (p.status === 'cancelled') classe += ' cancelled';
          else if (p.minutes <= 5) classe += ' highlight';
          else if (p.minutes > 50 || p.minutes < 0) classe += ' late';
          div.className = classe;
          div.innerHTML = isNaN(p.minutes) ? `Invalid` : `${p.heure}<br><small>${p.minutes} min</small>`;
          grid.appendChild(div);
        });
        block.appendChild(grid);
        el.appendChild(block);
      });
    }

    async function renderAll() {
      for (const [key, {name, refs}] of Object.entries(monitoringRefs)) {
        const allDeliveries = await Promise.all(refs.map(fetchData));
        renderDepartures(key, name, allDeliveries);
      }
    }

    async function getWeather() {
      try {
        const res = await fetch("https://wttr.in/Paris?format=1");
        const text = await res.text();
        document.getElementById("weather").textContent = `üå§Ô∏è M√©t√©o Paris : ${text.trim()}`;
      } catch (e) {
        document.getElementById("weather").textContent = "üå§Ô∏è M√©t√©o indisponible.";
      }
    }

    renderAll();
    getWeather();
    setInterval(renderAll, 30000);
    setInterval(getWeather, 1800000);
  </script>
</body>
</html>
